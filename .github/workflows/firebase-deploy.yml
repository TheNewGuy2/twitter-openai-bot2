name: Firebase Deployment

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      GCP_PROJECT: twitter-openai-bot2

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Authenticate to Google Cloud using your service account JSON in secrets.GCP_SA_KEY
      - name: Google Auth
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # Set up gcloud (lets us enable APIs, etc.)
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT }}

      # Install Firebase CLI
      - name: Install Firebase CLI
        run: curl -sL https://firebase.tools | bash

      # Enable required Google APIs (safe to run every time; no-ops if already enabled)
      - name: Enable required Google APIs
        run: |
          gcloud services enable \
            firebase.googleapis.com \
            cloudfunctions.googleapis.com \
            artifactregistry.googleapis.com \
            serviceusage.googleapis.com \
            runtimeconfig.googleapis.com \
            --project $GCP_PROJECT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: functions/package-lock.json

      - name: Install Dependencies
        working-directory: functions
        run: npm ci --legacy-peer-deps

      # If youâ€™re still using functions:config (Runtime Config), set them here.
      - name: Set Firebase Functions config
        run: |
          firebase functions:config:set openai.api_key="${{ secrets.OPENAI_API_KEY }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.api_key="${{ secrets.TWITTER_API_KEY }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.api_secret_key="${{ secrets.TWITTER_API_SECRET_KEY }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.access_token="${{ secrets.TWITTER_ACCESS_TOKEN }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.access_token_secret="${{ secrets.TWITTER_ACCESS_TOKEN_SECRET }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.user_id="${{ secrets.TWITTER_USER_ID }}" --project $GCP_PROJECT --non-interactive
          firebase functions:config:set twitter.username="${{ secrets.TWITTER_USERNAME }}" --project $GCP_PROJECT --non-interactive

      - name: Deploy to Firebase
        run: firebase deploy --only functions --project $GCP_PROJECT --non-interactive --force
